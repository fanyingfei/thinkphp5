<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" type="text/css" href="/editor/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/editor/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/editor/common.css">
    <link rel="stylesheet" type="text/css" href="/editor/wangCommon.css">
    <link rel="stylesheet" type="text/css" href="/editor/wangEditor.min.css">
    <link rel="stylesheet" type="text/css" href="/css/upload.jcrop.css">
    <link rel="stylesheet" type="text/css" href="/css/common.css">
    <title>私人笔记本</title>
</head>
<body>
<div class="loading-open"><p><img src="/img/loading_open.gif" alt="loading..." /></p></div>
<div class="main none">
    <div class="top-banner">
        <div class="top-left"></div>
        <div class="top-right">
            <div class="user-warp">
                <img class="user-avatar" src="" onerror="javascript:this.src='/img/avatar_default.jpg';" />
                <span class="user-name"></span>
            </div>
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="dir-hd">
                <div class="create-dir">新建文件夹</div>
                <div class="create-note">新建笔记</div>
            </div>
            <div class="dir-warp">
                <div class="widget-scroller-wrap">
                    <div class="scroller-container">
                        <div class="dir-list row-wrap"></div>
                        <div class="group-list row-wrap"></div>
                        <div class="sidebar-trash">
                            <div class="li-dir my-trash sidebar-title" data-id="-2" group-id="0" class-id="0">
                                <span class="down-btn"></span>
                                <i class="icon icon-trash"></i>
                                <div class="name">回收站</div>
                            </div>
                        </div>
                    </div>
                    <div class="widget-scroller-bar"></div>
                </div>
            </div>
            <div class="list-toggle"><i></i></div>
            <div class="drag-line"></div>
        </div>
        <div class="item-list">
            <div class="item-wrap">
                <div class="item-hd">
                    <div class="item-back" title="返回上一级"></div>
                    <div class="search-wrap">
                        <i class="search-icon"></i>
                        <input class="search-input" placeholder="搜索笔记" >
                    </div>
                    <div class="item-setting">
                        <i class="setting-icon"></i>
                        <ul class="dropdown-menu setting-menu">
                            <li class="setting-sel selected" data-value="all">全部<i></i></li>
                            <li class="li-divider setting-sel" data-value="note">笔记<i></i></li>
                            <li class="setting-sort selected desc" data-col="rank">默认排序<i></i></li>
                            <li class="setting-sort" data-col="create">创建时间<i></i></li>
                            <li class="setting-sort" data-col="update">修改时间<i></i></li>
                            <li class="setting-sort" data-col="title">文件名称<i></i></li>
                        </ul>
                    </div>
                </div>
                <div class="widget-scroller">
                    <div class="widget-scroller-wrap">
                        <div class="scroller-container">
                        </div>
                        <div class="widget-scroller-bar"></div>
                    </div>
                </div>
                <div class="item-num">总共 <span></span> 项</div>
                <div class="drag-line"></div>
            </div>
            <div class="detail-container">
                <div class="note-detail">
                    <div class="title-wrap">
                        <div><input type="text" class="note-name" /></div>
                        <button class="save btn btn-primary">保存</button>
                    </div>
                    <div class="note-scroller-wrap note-view" id="wangDemo"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="my-invite-list"></div>
</div>
<div class="none">
    <img id="drop-dir" src="/img/drap_dir.png" />
    <img id="drop-note" src="/img/drap_note.png" />
</div>
</body>
<script type="text/javascript" src="/js/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src='/editor/bootstrap.min.js'></script>
<script type="text/javascript" src='/editor/wangEditor.min.js'></script>
<script type="text/javascript" src="/editor/highlight.min.js"></script>
<script type="text/javascript" src="/editor/wangStart.js"></script>
<script type="text/javascript" src="/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/js/jquery.ui.js"></script>
<script type="text/javascript" src="/js/mouseevent.js"></script>
<script type="text/javascript" src="/js/rightmenu.js"></script>
<script type="text/javascript" src="/js/draggable.js"></script>
<script type="text/javascript" src="/js/ajax.transfer.js"></script>
<script type="text/javascript" src="/js/jquery.md5.js"></script>
<script type="text/javascript" src="/js/ajaxfileupload.js"></script>
<script type="text/javascript" src="/js/jquery.jcrop.js"></script>
<script type="text/javascript" src="/js/avatarCutter.js"></script>
<script type="text/javascript" src="/js/avatar.jcrop.js"></script>
<script type="text/javascript" src="/js/jquery.listen.js"></script>
<script type="text/javascript">

    $(document).ready(function(){
        start_init();
        ajax_polling();
        get_wangDemo_height();
    });

    function start_init(){
        init_user_info();
        //初始得到目录列表
        var sel_col = $.cookie('setting_col');
        var sel_sort = $.cookie('setting_sort');
        var sel_value = $.cookie('setting_value');
        if(sel_value !== undefined){
            $('.setting-sel').removeClass('selected');
            $('.setting-sel[data-value='+sel_value+']').addClass('selected');
        }
        if(sel_col !== undefined && sel_sort !== undefined){
            $('.setting-sort').removeClass('selected desc asc');
            $('.setting-sort[data-col='+sel_col+']').addClass(sel_sort+' selected');
        }

        var flag = dir_list();
        if(flag){
            $('.main').removeClass('none');
            $('.loading-open').remove();
        }
    }

    function init_user_info(){
        var data = get_user_info();
        if(data== '') return false;
        $('.user-warp .user-name').text(data.user_name);
        $('.user-warp .user-avatar').attr('src',data.avatar);
    }
    //监听创建目录
    $("body").on("click", '.create-dir', function(){
        if($(".dir-warp .curr").length > 0){
            var parent_id = $('.dir-warp .curr').data('id');
            var group_id = $('.dir-warp .curr').attr('group-id');
            var class_id = parseInt($('.dir-warp .curr').attr('class-id')) + 1;
        }else{
            var parent_id = 0;
            var class_id = 1;
            var group_id = 0;
        }

        create_dir(parent_id,class_id,group_id);
    })

    //创建目录的HTML
    function create_dir_html(obj,is_parent){
        var html = '<div class="li-dir rightbtn" group-id="'+obj.group_id+'" class-id="'+ obj.class_id+'" data-id="'+ obj.dir_id+'" >';
        if(is_parent == 1) html += '<span class="down-btn drop-down"></span>';
        else html += '<span class="down-btn"></span>';
        html += '<i class="icon"></i><div class="name">'+obj.dir_name+'</div>';
        html += '<div class="item-time">'+obj.time+'</div><i class="right-menu"></i></div>';
        return html;
    }

    //创建笔记的HTML
    function create_note_html(obj){
        var html = '<li class="note-drap"><div class="li-note rightbtn" group-id="'+obj.group_id+'" data-id="'+ obj.rec_id+'" parent-id="'+ obj.dir_id+'">';
        html += '<i class="icon"></i><div class="name">'+ obj.name+'</div><div class="item-time">'+ obj.time+'</div><i class="right-menu"></i></div></li>';
        return html;
    }

    function create_group_html(obj){
        var html = '<div class="li-group li-dir" group-id="'+ obj.group_id+'" data-id="0" class-id="0" version="'+obj.version+'">';
        if(obj.dir_list != undefined && obj.dir_list != '') html += '<span class="down-btn drop-down"></span>';
        else html += '<span class="down-btn"></span>';
        html += '<i class="icon"></i><div class="name">'+obj.group_name+'</div>';
        html += '<div class="item-time">'+obj.time+'</div><i class="right-menu"></i></div>';
        return html;
    }

    //得到富文本编辑器的高度
    function get_wangDemo_height(){
        var height = $('.note-detail').height() - $(".title-wrap").outerHeight() - 40;
        $('#wangDemo').height(height);
    }

    //浏览器大小改变的同时改变编辑器的高度
    window.onresize = function(){
        get_wangDemo_height();
        change_scroller_height($('.dir-warp .scroller-container'));
        change_scroller_height($('.item-wrap .scroller-container'));
    }

    function change_scroller_height(obj){
        if(obj.offset().top >= obj.parent().offset().top) return false;
        obj.css("margin-top", 0);
    }

    //关闭或者刷新浏览器时触发
    window.onbeforeunload = function(){
        if($('.dir-warp .li-dir.curr').length > 0){
            var dir_id = $('.dir-warp .li-dir.curr').data('id');
            var group_id = $('.dir-warp .li-dir.curr').attr('group-id');
        }else{
            var dir_id = 0;
            var group_id = 0;
        }
        $.cookie('currDir', dir_id , { path : '/' });
        $.cookie('currGroup', group_id , { path : '/' });

        if($('.item-note .li-note.curr').length > 0){
            var rec_id = $('.item-note .li-note.curr').data('id');
        }else{
            var rec_id = 0;
        }
        $.cookie('currNote', rec_id , { path : '/' });
    }

    //打开下拉目录的方法
    function open_dir(obj){
        var parent = obj.parent();
        if(parent.next('ul').is(":hidden")){
            parent.next('ul').slideDown('fast');
            obj.addClass('pack-up');
        }else{
            parent.parent().find('ul').slideUp('fast');
            parent.parent().find('ul').prev('div').children('.down-btn').removeClass('pack-up');
        }
        hide_dropdown_menu();
    }

    //创建目录列表的HTML，循环嵌套
    function create_list(obj , type){
        var html = '';
        $.each(obj, function(key, v){
            if(v.child){
                html += '<li>'+create_dir_html(v,1);
                html += create_list(v.child);
                html += '</li>';
            }else{
                html += '<li>'+create_dir_html(v,0)+'</li>';
            }
        })
        if(type == 'item')  return '<ul class="item-dir">'+html+'</ul>';
        else return '<ul class="sortable">'+html+'</ul>';
    }

    //没有任何目录和笔记时调用此方法
    function no_item_html(){
        empty_note();
        if($('.item-wrap .scroller-container > ul > li').length == 0){
            var html = '<div class="no-item"><p>列表空空如也~</p></div>';
            $('.item-note').html(html);
        }else{
            $('.no-item').remove();
        }
    }

    //没有笔记时view的显示
    function empty_note(){
        if($('.item-note .rightbtn').length > 0) return false;
        var obj = $('.detail-container');
        if(obj.hasClass('empty')) return false;
        obj.addClass('empty').children().hide().end().append('<div class="empty-img"></div>');
        $('.title-wrap input').val('');
        $('.note-detail .note-view').html('');
    }

</script>
</html>