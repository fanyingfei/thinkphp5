<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="/wangEditor/jquery-1.10.2.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/wangEditor/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/common.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/index.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/wangEditor.min.css">
    <link rel="stylesheet" href="/css/common.css"/>
</head>
<body>
<div class="sidebar">
    <div class="create-dir">新建文件夹</div><br>
    <div class="create-art">新建笔记</div><br>
    <div class="dirlist"></div>
</div>

<div id="itemlist" class="itemlist"></div>

<div id="article" class="article">
    <div class="title-wrapper">
        <input id="article-id" type="hidden" />
        <h2 contenteditable="true" class="title"></h2>
        <button class="save btn btn-primary">保存</button>
    </div>
    <div class="content" id="wangDemo"></div>
</div>
<ul class="dropdown-menu dir-right-menu" role="menu">
    <li class="move-up">上移</li>
    <li class="move-down">下移</li>
    <li class="delete">删除</li>
    <li class="li-divider rename">重命名</li>
    <li class="right-create-art">新建笔记</li>
    <li class="right-create-dir">新建文件夹</li>
</ul>
<div class="none">
    <img id="drop-dir" src="/img/drap.png" />
    <img id="drop-article" src="/img/drap.png" />
</div>
</body>
<script type="text/javascript" src='/wangEditor/bootstrap.min.js'></script>
<script type="text/javascript" src='/wangEditor/wangEditor.min.js'></script>
<script type="text/javascript" src="/wangEditor/index.js"></script>
<script type="text/javascript" src="/js/rightmenu.js"></script>
<script type="text/javascript" src="/js/drag.js"></script>
<script type="text/javascript">

    $("body").on("click", '.create-dir', function(){
        if($(".dirlist .curr").length > 0){
            var parent_id = $('.dirlist li .curr').data('id');
            var class_id = parseInt($('.dirlist li .curr').attr('class-id')) + 1;
        }else{
            var parent_id = 0;
            var class_id = 1;
        }
        RightType = 'dir';
        create_dir(parent_id,class_id);
    })

    function create_dir(parent_id,class_id){
        $.ajax({
            url:  '/dir/create_dir',
            data:{'parent_id':parent_id,'class_id':class_id},
            type: "POST",
            dataType:'json',
            success:function(id){
                var html = '<li>'+create_dir_html(class_id,id,'新建文件夹',0)+'</li>';
                if(class_id == 1){
                    $('.dirlist > ul').append(html);
                }else{
                    var obj = $(".dirlist .li-dir[data-id="+parent_id+"]");
                    if(obj.next('ul').length > 0){
                        obj.next('ul').append(html);
                    }else{
                        obj.after('<ul>'+html+'</ul>');
                    }
                    obj.children('.drop-down').text('-');
                    obj.next('ul').show();

                    if(parent_id == $('.itemlist').attr('parent-id')){
                        $('.item-dir').append(html);
                    }
                }
                create_update_name($(".dirlist .li-dir[data-id="+id+"]"));
            },
            error:function(e){}
        });
    }

    function create_dir_html(class_id,dir_id,dir_name,is_parent){
        var html = '<div draggable="true" class="li-dir rightbtn" class-id="'+ class_id+'" data-id="'+ dir_id+'" >';
        if(is_parent == 1) html += '<span class="drop-down">+</span>';
        else html += '<span class="drop-down"></span>';
        html += '<i class="icon"></i><div class="name">'+dir_name+'</div><i class="right-menu"></i></div>';
        return html;
    }

    function create_article_html(id,name,time){
        return '<li><div class="li-article rightbtn" data-id="'+id+'"><i class="icon"></i><div class="name">'+name+'</div><div class="art-time">'+time+'</div><i class="right-menu"></i></div></li>';
    }

    $("body").on("click", '.create-art', function(){
        var obj = $(this);
        if($(".li-dir").hasClass("curr")){
            var dir_id = $('.li-dir.curr').data('id');
        }else{
            var dir_id = $('.sidebar .li-dir:first-child').data('id');
        }

        $.ajax({
            url:  '/dir/article_create',
            data:{'dir_id':dir_id},
            type: "POST",
            dataType:'json',
            success:function(obj){
                var id = obj.id;
                if($('#itemlist .item-article li').length > 0){
                    $('#itemlist .item-article li').eq(0).before(create_article_html(id,'新建笔记',obj.time));
                }else{
                    $('#itemlist .item-article').prepend(create_article_html(id,'新建笔记',obj.time));
                }
                $('.li-article.curr').next('ul').show();
                $('.li-article.curr').removeClass('curr');
                $(".li-article[data-id="+id+"]").addClass('curr');
                $('.title').html('新建笔记');
                $('.content').html('');
                $('#article-id').val(id);
            },
            error:function(e){}
        });
    })

    $("body").on("click", '.li-dir', function(){
        $('.li-dir.curr').removeClass('curr');
        var dir_id = $(this).data('id');
        $(".li-dir[data-id="+dir_id+"]").addClass('curr');
        $(".li-dir[data-id="+dir_id+"]").parents('ul').show();
        item_list();
    })


    $("body").on("click", '.li-article', function(){
        $('.li-article.curr').removeClass('curr');
        var rec_id = $(this).data('id');
        $(".li-article[data-id="+rec_id+"]").addClass('curr');
        show_article(rec_id);
    })

    $("body").on("click", '.li-dir span:first-child', function(){
        if($(this).parent().next('ul').is(":hidden")){
            $(this).parent().next('ul').show();
            $(this).html('-');
        }else{
            $(this).parent().next('ul').hide();
            $(this).html('+');
        }
        return false;
    })

    dir_list();
    function dir_list(){
        $.ajax({
            url:  '/dir/dir_list',
            data:{},
            type: "POST",
            dataType:'json',
            success:function(obj){
                var html = creat_list(obj);
                $('.dirlist').html(html);
                item_list();
            },
            error:function(e){}
        });
    }

    function creat_list(obj){
        var html = '<ul>';
        $.each(obj, function(key, v){
            if(v.child){
                html += '<li>'+create_dir_html(v.class_id, v.dir_id,v.dir_name,1);
                html += creat_list(v.child);
                html += '</li>';
            }else{
                html += '<li>'+create_dir_html(v.class_id, v.dir_id,v.dir_name,0)+'</li>';
            }
        })
        return html += '</ul>';
    }

    function item_list(){
        var id = $('.li-dir.curr').data('id');
        if(id == undefined){
            id = $('.sidebar .li-dir:first-child').data('id');
            $(".sidebar .li-dir[data-id="+id+"]").addClass('curr');
        }
        $.ajax({
            url:  '/dir/item_list',
            data:{'dir_id':id},
            type: "POST",
            dataType:'json',
            success:function(obj){
                $('.itemlist').attr('parent-id',id);
                var html = '<ul class="item-dir">';
                var rec_id = 0;
                $.each(obj.dir, function(key, v){
                    html += '<li>'+create_dir_html(v.class_id, v.dir_id, v.dir_name,0)+'</li>';
                })
                html += '</ul><ul class="item-article">';
                $.each(obj.art, function(key, v){
                    if(key == 0) rec_id= v.rec_id;
                    html += create_article_html(v.rec_id, v.title, v.time);
                })
                html += '</ul>';
                $('.itemlist').html(html);
                if(rec_id != 0){
                    show_article(rec_id);
                    $(".li-article[data-id="+rec_id+"]").addClass('curr');
                }else{
                    $('.article .title').html('');
                    $('.article .content').html('');
                }
            },
            error:function(e){}
        });
    }

    function show_article(rec_id){
        $.ajax({
            url:  '/dir/article',
            data:{'rec_id':rec_id},
            type: "POST",
            dataType:'json',
            success:function(obj){
                $('.article .title').html(obj.title);
                $('#article-id').val(obj.rec_id);
                $('.article .content').html(obj.content);
            },
            error:function(e){}
        });
    }

    $("body").on("click", '.save', function(){
        var title = $('.title').text();
        var rec_id = $('#article-id').val();
        var content = $('#divDemo').html();
        $.ajax({
            url:  '/dir/article_update',
            data:{'title':title,'content':content,'rec_id':rec_id},
            type: "POST",
            dataType:'json',
            success:function(obj){
                $(".li-article[data-id="+rec_id+"] .name").html(title);
                alert('success');
            },
            error:function(e){}
        });
    })


</script>

</body>
</html>