<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/wangEditor/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/common.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/index.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/wangEditor.min.css">
    <link rel="stylesheet" href="/css/common.css"/>
    <title>私人笔记本</title>
</head>
<body>
<div class="loading-open"><img src="/img/loading_open.gif" alt="loading..." /></div>
<div class="main none">
    <div class="top-banner"></div>
    <div class="main-container">
        <div class="sidebar">
            <div class="dir-hd">
                <div class="create-dir">新建目录</div>
                <div class="create-note">新建笔记</div>
            </div>
            <div class="dir-warp">
                <div class="widget-scroller-wrap">
                    <div class="scroller-container">
                        <div class="dir-list"></div>
                    </div>
                    <div class="widget-scroller-bar"></div>
                </div>
            </div>
            <div class="list-toggle"><i></i></div>
            <div class="drag-line"></div>
        </div>

        <div class="item-list">
            <div class="item-wrap">
                <div class="item-hd">
                    <div class="item-back"></div>
                    <div class="search-wrap">
                        <i class="search-icon"></i>
                        <input class="search-input" placeholder="搜索" >
                    </div>
                    <div class="item-setting">
                        <i class="setting-icon"></i>
                        <ul class="dropdown-menu setting-menu">
                            <li class="setting-sel selected" data-value="all">全部<i></i></li>
                            <li class="li-divider setting-sel" data-value="note">笔记<i></i></li>
                            <li class="setting-sort selected desc" data-col="rank">默认排序<i></i></li>
                            <li class="setting-sort" data-col="create">创建时间<i></i></li>
                            <li class="setting-sort" data-col="update">修改时间<i></i></li>
                            <li class="setting-sort" data-col="title">文件名称<i></i></li>
                        </ul>
                    </div>
                </div>
                <div class="widget-scroller">
                    <div class="widget-scroller-wrap">
                        <div class="scroller-container">
                            <ul class="item-dir"></ul>
                            <ul class="item-note"></ul>
                        </div>
                        <div class="widget-scroller-bar"></div>
                    </div>
                </div>
                <div class="drag-line"></div>
            </div>
            <div class="detail-container">
                <div class="note-detail">
                    <div class="title-wrap">
                        <input id="note-id" type="hidden" />
                        <input type="text" prevalue="" class="title" />
                        <button class="save btn btn-primary">保存</button>
                    </div>
                    <div class="note-scroller-wrap note-view" id="wangDemo"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<ul class="dropdown-menu dir-right-menu" role="menu">
    <li class="move-up">上移</li>
    <li class="move-down">下移</li>
    <li class="delete">删除</li>
    <li class="li-divider rename">重命名</li>
    <li class="right-create-note">新建笔记</li>
    <li class="right-create-dir">新建文件夹</li>
</ul>
<div class="none">
    <img id="drop-dir" src="/img/drap_dir.png" />
    <img id="drop-note" src="/img/drap_note.png" />
</div>
</body>
<script type="text/javascript" src="/wangEditor/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src='/wangEditor/bootstrap.min.js'></script>
<script type="text/javascript" src='/wangEditor/wangEditor.min.js'></script>
<script type="text/javascript" src="/wangEditor/index.js"></script>
<script type="text/javascript" src="/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/js/mouseevent.js"></script>
<script type="text/javascript" src="/js/rightmenu.js"></script>
<script type="text/javascript" src="/js/drag.js"></script>
<script type="text/javascript" src="/js/ajax.request.js"></script>
<script type="text/javascript" src="/js/jquery.md5.js"></script>
<script type="text/javascript">
    start_init();

    function start_init(){
        //初始得到目录列表
        var sel_col = $.cookie('setting_col');
        var sel_sort = $.cookie('setting_sort');
        var sel_value = $.cookie('setting_value');
        if(sel_value !== undefined){
            $('.setting-sel').removeClass('selected');
            $('.setting-sel[data-value='+sel_value+']').addClass('selected');
        }
        if(sel_col !== undefined && sel_sort !== undefined){
            $('.setting-sort').removeClass('selected desc asc');
            $('.setting-sort[data-col='+sel_col+']').addClass(sel_sort+' selected');
        }
        var flag = dir_list();
        if(flag){
            $('.main').removeClass('none');
            $('.loading-open').remove();
        }
    }
    //监听创建目录
    $("body").on("click", '.create-dir', function(){
        if($(".dir-list .curr").length > 0){
            var parent_id = $('.dir-list .li-dir.curr').data('id');
            var class_id = parseInt($('.dir-list .li-dir.curr').attr('class-id')) + 1;
        }else{
            var parent_id = 0;
            var class_id = 1;
        }
        RightType = 'dir';
        if($('.item-note .no-item').length > 0 ) $('.no-item').remove();
        create_dir(parent_id,class_id);
    })

    //创建目录的HTML
    function create_dir_html(obj,is_parent){
        var html = '<div draggable="true" class="li-dir rightbtn" class-id="'+ obj.class_id+'" data-id="'+ obj.dir_id+'" >';
        if(is_parent == 1) html += '<span class="down-btn drop-down"></span>';
        else html += '<span class="down-btn"></span>';
        html += '<i class="icon"></i><div class="name">'+obj.dir_name+'</div>';
        html += '<div class="item-time">'+obj.time+'</div><i class="right-menu"></i></div>';
        return html;
    }

    //创建笔记的HTML
    function create_note_html(obj){
        return '<li><div draggable="true" class="li-note rightbtn" data-id="'+ obj.rec_id+'"><i class="icon"></i><div class="name">'+ obj.title+'</div><div class="item-time">'+ obj.time+'</div><i class="right-menu"></i></div></li>';
    }

    //监听创建笔记
    $("body").on("click", '.create-note', function(){
        if($(".li-dir").hasClass("curr")){
            var dir_id = $('.li-dir.curr').data('id');
        }else{
            var dir_id = $('.sidebar .li-dir:first-child').data('id');
        }
        create_note(dir_id);
    })

    //得到富文本编辑器的高度
    function get_wangDemo_height(){
        var height = $('.note-detail').height() - $("#wangDemo").offset().top + 30;
        $('#wangDemo').height(height);
    }

    //浏览器大小改变的同时改变编辑器的高度
    window.onresize = function(){
        get_wangDemo_height();
        change_scroller_height($('.dir-warp .scroller-container'));
        change_scroller_height($('.item-wrap .scroller-container'));
    }

    function change_scroller_height(obj){
        if(obj.offset().top >= obj.parent().offset().top) return false;
        obj.css("margin-top", 0);
    }

    //关闭或者刷新浏览器时触发
    window.onbeforeunload = function(){
        if($('.dir-list .li-dir.curr').length > 0) var dir_id = $('.dir-list .li-dir.curr').data('id');
        else var dir_id = 0;
        $.cookie('currDir', dir_id , { path : '/' });

        if($('.item-note .li-note.curr').length > 0) var rec_id = $('.item-note .li-note.curr').data('id');
        else var rec_id = 0;
        $.cookie('currNote', rec_id , { path : '/' });
    }

    //监听打开笔记
    $("body").on("click", '.li-note', function(){
        $('.li-note.curr').removeClass('curr');
        var rec_id = $(this).data('id');
        $(".li-note[data-id="+rec_id+"]").addClass('curr');
        show_note();
    })

    var clickTime ; //取消双击时触发单机事件
    //监听打开目录
    $("body").on("click", '.li-dir', function(){
        var dir_id = $(this).data('id');
        clearTimeout(clickTime);
        clickTime = setTimeout(function() {
            $('.dir-list .li-dir.curr').removeClass('curr');
            var obj = $(".dir-list .li-dir[data-id="+dir_id+"]");
            var downBtn = obj.parent('li').parent('ul').prev('.li-dir').children('.down-btn');
            obj.addClass('curr');
            obj.parents('ul').show();
            if(!downBtn.hasClass('pack-up')) downBtn.addClass('pack-up');
            item_list();
            show_note();
        },10);
    })

    //双击目录同样触发下单事件
    $("body").on("dblclick", '.dir-list .li-dir', function(){
        clearTimeout(clickTime);
        open_dir($(this).children('.down-btn'));
        return false;
    })

    //监听目录下拉事件
    $("body").on("click", '.li-dir .drop-down', function(){
        open_dir($(this));
        return false;
    })

    //打开下拉目录的方法
    function open_dir(obj){
        var parent = obj.parent();
        if(parent.next('ul').is(":hidden")){
            parent.next('ul').show();
            obj.addClass('pack-up');
        }else{
            parent.parent().find('ul').hide();
            parent.parent().find('ul').prev('.li-dir').children('.down-btn').removeClass('pack-up');
        }
        $(".dir-right-menu").hide();
    }

    //创建目录列表的HTML，循环嵌套
    function creat_list(obj){
        var html = '<ul>';
        $.each(obj, function(key, v){
            if(v.child){
                html += '<li>'+create_dir_html(v,1);
                html += creat_list(v.child);
                html += '</li>';
            }else{
                html += '<li>'+create_dir_html(v,0)+'</li>';
            }
        })
        return html += '</ul>';
    }

    //没有任何目录和笔记时调用此方法
    function no_item_html(){
        empty_note();
        if($('.item-wrap ul .rightbtn').length == 0){
            var html = '<div class="no-item"><p>没有找到文件</p><button class="btn create-note">新建笔记</button></div>';
            $('.item-note').html(html);
        }
    }

    //没有笔记时view的显示
    function empty_note(){
        if($('.item-note ul .rightbtn').length > 0) return false;
        var obj = $('.detail-container');
        if(obj.hasClass('empty')) return false;
        obj.addClass('empty').children().hide().end().append('<div class="empty-img"></div>');
        $('.title-wrap input').val('');
        $('.note-detail .note-view').html('');
    }

    //焦点离开笔记时触发，调用保存方法
    $("body").on("blur", '.note-detail', function(e){
        var content = $('#wangDemo').html();
        if($.md5(content) == $('#wangDemo').attr('precontent')) return false;
        save_note(false); //false自动保存，不要弹框提示
    })

    //保存笔记，调用保存方法
    $("body").on("click", '.save', function(){
        var title = $('.title').val();
        if(title == '') alert('标题不能为空');
        save_note(true);//true手动保存，需弹框提示
    })

    //笔记标题改变时同步中间的笔记名
    $('.title-wrap .title').bind('input propertychange', function() {
        $('.li-note.curr .name').text($(this).val());
    });

    $("body").on("blur", '.title-wrap .title', function(e){
        var name = $('.title-wrap .title').val();
        var rec_id = $('.title-wrap #note-id').val();
        if(name == $('.title-wrap .title').attr('prevalue')) return false;
        ajax_update_name('/dir/update_note_name',name,rec_id);
    })

    //展示笔记
    function show_note(){
        //没有任何笔记时
        if($('.item-note li').length == 0){
            empty_note();
            return false;
        }

        if($('.detail-container').hasClass('empty')){
            $('.detail-container .empty-img').remove();
            $('.detail-container').removeClass('empty').children().show();
        }
        //有笔记时
        if($('.item-note .li-note.curr').length > 0){
            var rec_id = $('.item-note .li-note.curr').data('id')
        }else if($.cookie('currNote') && $('.item-note .li-note[data-id='+$.cookie('currNote')+']').parents('.item-list').length>0
                && $('.dir-list .li-dir.curr').data('id') == $('.item-list').attr('parent-id')){
            var rec_id = $.cookie('currNote');
        }else{
            var rec_id = $('.item-note li:first-child .li-note').data('id');
        }

        $('.item-note .li-note[data-id='+rec_id+']').addClass('curr');
        ajax_show_note(rec_id);
    }

    //点击搜索图标
    $("body").on("click", '.search-icon', function(){
        search_note();
    })
    //回车搜索
    $("body").on("keydown", '.search-input', function(e){
        if(e.which == 13) search_note();
    });

    //回到上一级
    $("body").on("click", '.item-back', function(){
        var dir_id = $('.item-list').attr('parent-id');
        if(dir_id == 0) return false;
        $('.dir-list .li-dir.curr').removeClass('curr');
        var obj = $('.dir-list .li-dir[data-id='+dir_id+']').parent().parent().prev('.li-dir');
        if(obj.data('id') == 0) $('.item-back').addClass('disabled');
        obj.addClass('curr').parents('ul').show().prev('.li-dir').children('.down-btn').addClass('pack-up');
        item_list();
    })

    //item设置
    $("body").on("click", '.setting-icon', function(){
        hide_dropdown_menu();
        $('.setting-menu').show();
        return false;
    })

    $("body").on("click", '.setting-sel', function(){
        $('.setting-sel').removeClass('selected');
        $('.item-note .no-item').remove();
        $(this).addClass('selected');
        $.cookie('setting_value',$(this).data('value'));
        item_list();
        show_note();
    })

    $("body").on("click", '.setting-sort', function(){
        if($(this).hasClass('desc')){
            var order_by = 'asc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }else if($(this).hasClass('asc')){
            var order_by = 'desc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }else{
            var order_by = 'desc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }
        $.cookie('setting_col',$(this).data('col'));
        $.cookie('setting_sort',order_by);
        item_list();
        show_note();
    })

    function alert_msg(status,msg){
        if($('.hint-container').length > 0){
            $('.hint-container').remove();
        }
        var html = '<div class="hint-container"><div class="widget-hint"><p class="'+status+'"><span class="icon-hint"></span><span class="hint-msg">'+msg+'</span></p></div></div>';

        $('.detail-container').append(html);
        var obj = $('.hint-container');
        obj.fadeIn(500);
        setTimeout(function(){
            obj.fadeOut(500,function(){
                if(obj != undefined) obj.remove();
            });
        },2000);
    }
</script>
</html>