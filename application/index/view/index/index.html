<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" type="text/css" href="/wangEditor/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/common.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/index.css">
    <link rel="stylesheet" type="text/css" href="/wangEditor/wangEditor.min.css">
    <link rel="stylesheet" href="/css/common.css"/>
    <title>私人笔记本</title>
</head>
<body>
<div class="loading-open"><p><img src="/img/loading_open.gif" alt="loading..." /></p></div>
<div class="main none">
    <div class="top-banner">
        <div class="top-left"></div>
        <div class="top-right">
            <span class="user-name"></span>
        </div>
    </div>
    <div class="main-container">
        <div class="sidebar">
            <div class="dir-hd">
                <div class="create-dir">新建目录</div>
                <div class="create-note">新建笔记</div>
            </div>
            <div class="dir-warp">
                <div class="widget-scroller-wrap">
                    <div class="scroller-container">
                        <div class="dir-list row-wrap"></div>
                        <div class="group-list row-wrap"></div>
                        <div class="sidebar-trash">
                            <i class="icon-trash"></i>
                            <div class="text-trash">回收站</div>
                        </div>
                    </div>
                    <div class="widget-scroller-bar"></div>
                </div>
            </div>
            <div class="list-toggle"><i></i></div>
            <div class="drag-line"></div>
        </div>
        <div class="item-list">
            <div class="item-wrap">
                <div class="item-hd">
                    <div class="item-back" title="返回上一级"></div>
                    <div class="search-wrap">
                        <i class="search-icon"></i>
                        <input class="search-input" placeholder="搜索笔记" >
                    </div>
                    <div class="item-setting">
                        <i class="setting-icon"></i>
                        <ul class="dropdown-menu setting-menu">
                            <li class="setting-sel selected" data-value="all">全部<i></i></li>
                            <li class="li-divider setting-sel" data-value="note">笔记<i></i></li>
                            <li class="setting-sort selected desc" data-col="rank">默认排序<i></i></li>
                            <li class="setting-sort" data-col="create">创建时间<i></i></li>
                            <li class="setting-sort" data-col="update">修改时间<i></i></li>
                            <li class="setting-sort" data-col="title">文件名称<i></i></li>
                        </ul>
                    </div>
                </div>
                <div class="widget-scroller">
                    <div class="widget-scroller-wrap">
                        <div class="scroller-container">
                        </div>
                        <div class="widget-scroller-bar"></div>
                    </div>
                </div>
                <div class="item-num">总共 <span></span> 项</div>
                <div class="drag-line"></div>
            </div>
            <div class="detail-container">
                <div class="note-detail">
                    <div class="title-wrap">
                        <input id="note-id" type="hidden" />
                        <input type="text" prevalue="" class="title" />
                        <button class="save btn btn-primary">保存</button>
                    </div>
                    <div class="note-scroller-wrap note-view" id="wangDemo"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="my-invite-list"></div>
</div>
<div class="none">
    <img id="drop-dir" src="/img/drap_dir.png" />
    <img id="drop-note" src="/img/drap_note.png" />
</div>
</body>
<script type="text/javascript" src="/wangEditor/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src='/wangEditor/bootstrap.min.js'></script>
<script type="text/javascript" src='/wangEditor/wangEditor.min.js'></script>
<script type="text/javascript" src="/wangEditor/index.js"></script>
<script type="text/javascript" src="/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/js/jquery.ui.js"></script>
<script type="text/javascript" src="/js/mouseevent.js"></script>
<script type="text/javascript" src="/js/rightmenu.js"></script>
<script type="text/javascript" src="/js/draggable.js"></script>
<script type="text/javascript" src="/js/ajax.request.js"></script>
<script type="text/javascript" src="/js/jquery.md5.js"></script>
<script type="text/javascript">

    $(document).ready(function(){
        start_init();
        get_invite_group();
        get_wangDemo_height();
    });

    function start_init(){
        get_user_info();
        //初始得到目录列表
        var sel_col = $.cookie('setting_col');
        var sel_sort = $.cookie('setting_sort');
        var sel_value = $.cookie('setting_value');
        if(sel_value !== undefined){
            $('.setting-sel').removeClass('selected');
            $('.setting-sel[data-value='+sel_value+']').addClass('selected');
        }
        if(sel_col !== undefined && sel_sort !== undefined){
            $('.setting-sort').removeClass('selected desc asc');
            $('.setting-sort[data-col='+sel_col+']').addClass(sel_sort+' selected');
        }
        group_list();
        var flag = dir_list();
        if(flag){
            $('.main').removeClass('none');
            $('.loading-open').remove();
        }
    }
    //监听创建目录
    $("body").on("click", '.create-dir', function(){
        if($('.my-group-list.curr').length > 0){
            alert('请选择具体的协作目录');
            return false;
        }
        if($(".dir-warp .curr").length > 0){
            var parent_id = $('.dir-warp .curr').data('id');
            var group_id = $('.dir-warp .curr').attr('group-id');
            var class_id = parseInt($('.dir-warp .curr').attr('class-id')) + 1;
        }else{
            var parent_id = 0;
            var class_id = 1;
            var group_id = 0;
        }
        RightType = 'dir';
        if($('.item-note .no-item').length > 0 ) $('.no-item').remove();
        create_dir(parent_id,class_id,group_id);
    })

    //创建目录的HTML
    function create_dir_html(obj,is_parent){
        var className = '';
        if(obj.group_id > 0) var className = ' item-group';
        var html = '<div class="li-dir'+className+' rightbtn" group-id="'+obj.group_id+'" class-id="'+ obj.class_id+'" data-id="'+ obj.dir_id+'" >';
        if(is_parent == 1) html += '<span class="down-btn drop-down"></span>';
        else html += '<span class="down-btn"></span>';
        html += '<i class="icon"></i><div class="name">'+obj.dir_name+'</div>';
        html += '<div class="item-time">'+obj.time+'</div><i class="right-menu"></i></div>';
        return html;
    }

    //创建笔记的HTML
    function create_note_html(obj){
        var html = '<li class="note-drap"><div class="li-note rightbtn" group-id="'+obj.group_id+'" data-id="'+ obj.rec_id+'" parent-id="'+ obj.dir_id+'">';
        html += '<i class="icon"></i><div class="name">'+ obj.title+'</div><div class="item-time">'+ obj.time+'</div><i class="right-menu"></i></div></li>';
        return html;
    }

    function create_group_html(obj){
        var html = '<div class="li-group" group-id="'+ obj.group_id+'" data-id="0" class-id="0" version="'+obj.version+'">';
        if(obj.dir_list != undefined && obj.dir_list != '') html += '<span class="down-btn drop-down"></span>';
        else html += '<span class="down-btn"></span>';
        html += '<i class="icon"></i><div class="name">'+obj.group_name+'</div>';
        html += '<div class="item-time">'+obj.time+'</div><i class="right-menu"></i></div>';
        return html;
    }

    //监听创建笔记
    $("body").on("click", '.create-note', function(){
        if($('.my-group-list.curr').length > 0){
            alert('请选择具体的协作目录');
            return false;
        }
        if($(".dir-warp .curr").length > 0){
            var dir_id = $('.curr').data('id');
            var group_id = $('.curr').attr('group-id');
        }else{
            var dir_id = $('.dir-warp .li-dir:first-child').data('id');
        }
        create_note(dir_id,group_id);
    })

    //得到富文本编辑器的高度
    function get_wangDemo_height(){
        var height = $('.note-detail').height() - $(".title-wrap").outerHeight() - 40;
        $('#wangDemo').height(height);
    }

    //浏览器大小改变的同时改变编辑器的高度
    window.onresize = function(){
        get_wangDemo_height();
        change_scroller_height($('.dir-warp .scroller-container'));
        change_scroller_height($('.item-wrap .scroller-container'));
    }

    function change_scroller_height(obj){
        if(obj.offset().top >= obj.parent().offset().top) return false;
        obj.css("margin-top", 0);
    }

    //关闭或者刷新浏览器时触发
    window.onbeforeunload = function(){
        if($('.dir-list .li-dir.curr').length > 0) var dir_id = $('.dir-list .li-dir.curr').data('id');
        else var dir_id = 0;
        $.cookie('currDir', dir_id , { path : '/' });

        if($('.item-note .li-note.curr').length > 0) var rec_id = $('.item-note .li-note.curr').data('id');
        else var rec_id = 0;
        $.cookie('currNote', rec_id , { path : '/' });
    }

    //监听打开笔记
    $("body").on("click", '.li-note', function(){
        $('.li-note.curr').removeClass('curr');
        var rec_id = $(this).data('id');
        $(".li-note[data-id="+rec_id+"]").addClass('curr');
        show_note();
    })

    //监听回收站
    $("body").on("click", '.sidebar-trash', function(){
        $('.search-input').val('');
        $('.dir-warp .curr').removeClass('curr');
        $(this).addClass('curr');
        ajax_trash_list();
        show_note();
    })

    var clickTime ; //取消双击时触发单机事件
    //监听打开目录
    $("body").on("click", '.li-dir', function(){
        $('.search-input').val('');
        var clickObj = $(this);
        var dir_id = clickObj.data('id');
        if(clickObj.hasClass('li-trash')) return false;
        if(clickObj.parent().hasClass('ui-sortable-helper')) return false;//拖放排序时取消单击事件
        clearTimeout(clickTime);
        clickTime = setTimeout(function() {
            $('.dir-warp .curr').removeClass('curr');
            if(clickObj.hasClass('item-group')){
                var curObj = $(".group-list .li-dir[data-id="+dir_id+"]");
            }else{
                var curObj = $(".dir-list .li-dir[data-id="+dir_id+"]");
            }
            var downBtn = curObj.parent('li').parent('ul').prev('div').children('.down-btn');
            curObj.addClass('curr');
            curObj.parents('ul').slideDown('fast');
            if(!downBtn.hasClass('pack-up')) downBtn.addClass('pack-up');
            item_list_dir();
            show_note();
        },10);
    })

    //双击目录同样触发下单事件
    $("body").on("dblclick", '.li-dir', function(){
        clearTimeout(clickTime);
        open_dir($(this).children('.down-btn'));
        return false;
    })

    //双击协作同样触发下单事件
    $("body").on("dblclick", '.li-group', function(){
        clearTimeout(clickTime);
        open_dir($(this).children('.down-btn'));
        return false;
    })

    $("body").on("click", '.li-group', function(){
        $('.search-input').val('');
        var clickObj = $(this);
        var group_id = $(this).attr('group-id');
        if(clickObj.hasClass('li-trash')) return false;
        if(clickObj.parent().hasClass('ui-sortable-helper')) return false;//拖放排序时取消单击事件
        clearTimeout(clickTime);
        clickTime = setTimeout(function() {
            $('.dir-warp .curr').removeClass('curr');
            clickObj.addClass('curr');
            if(clickObj.hasClass('my-group-list')){
                item_group();
            }else{
                var curObj = $(".group-list .li-group[group-id="+group_id+"]");
                var downBtn = curObj.parent('li').parent('ul').prev('div').children('.down-btn');
                curObj.addClass('curr');
                curObj.parents('ul').slideDown('fast');
                if(!downBtn.hasClass('pack-up')) downBtn.addClass('pack-up');
                item_list_group();
            }
        },10);
    })

    //监听目录下拉事件
    $("body").on("click", '.drop-down', function(){
        open_dir($(this));
        return false;
    })

    //打开下拉目录的方法
    function open_dir(obj){
        var parent = obj.parent();
        if(parent.next('ul').is(":hidden")){
            parent.next('ul').slideDown('fast');
            obj.addClass('pack-up');
        }else{
            parent.parent().find('ul').slideUp('fast');
            parent.parent().find('ul').prev('div').children('.down-btn').removeClass('pack-up');
        }
        hide_dropdown_menu();
    }

    //创建目录列表的HTML，循环嵌套
    function create_list(obj , type){
        var html = '';
        $.each(obj, function(key, v){
            if(v.child){
                html += '<li>'+create_dir_html(v,1);
                html += create_list(v.child);
                html += '</li>';
            }else{
                html += '<li>'+create_dir_html(v,0)+'</li>';
            }
        })
        if(type == 'item')  return '<ul class="item-dir">'+html+'</ul>';
        else return '<ul class="sortable">'+html+'</ul>';
    }

    //没有任何目录和笔记时调用此方法
    function no_item_html(){
        empty_note();
        if($('.item-wrap .scroller-container ul.item-group').length > 0 && $('.item-wrap .scroller-container ul.item-group li').length == 0){
            $('.item-wrap .scroller-container ul.item-group').html('<div class="no-item"><p>还没有协作</p></div>');
            return false;
        }
        if($('.item-wrap ul .rightbtn').length == 0){
            var html = '<div class="no-item"><p>没有找到文件</p><button class="btn create-note">新建笔记</button></div>';
            $('.item-note').html(html);
        }
    }

    function no_trash_html(){
        if($('.item-wrap ul .rightbtn').length == 0){
            var html = '<div class="no-item"><p>回收站为空</p></div>';
            $('.item-note').html(html);
        }
    }

    //没有笔记时view的显示
    function empty_note(){
        if($('.item-note .rightbtn').length > 0) return false;
        var obj = $('.detail-container');
        if(obj.hasClass('empty')) return false;
        obj.addClass('empty').children().hide().end().append('<div class="empty-img"></div>');
        $('.title-wrap input').val('');
        $('.note-detail .note-view').html('');
    }

    //焦点离开笔记时触发，调用保存方法
    $("body").on("blur", '.note-detail', function(e){
        var content = $('#wangDemo').html();
        if($.md5(content) == $('#wangDemo').attr('precontent')) return false;
        save_note(false); //false自动保存，不要弹框提示
    })

    //保存笔记，调用保存方法
    $("body").on("click", '.save', function(){
        var title = $('.title').val();
        if(title == '') alert('标题不能为空');
        save_note(true);//true手动保存，需弹框提示
    })

    //笔记标题改变时同步中间的笔记名
    $('.title-wrap .title').bind('input propertychange', function() {
        $('.li-note.curr .name').text($(this).val());
    });

    $("body").on("blur", '.title-wrap .title', function(e){
        var name = $('.title-wrap .title').val();
        var rec_id = $('.title-wrap #note-id').val();
        if(name == $('.title-wrap .title').attr('prevalue')) return false;
        ajax_update_name('/dir/update_note_name',name,rec_id);
    })

    //展示笔记
    function show_note(){
        //没有任何笔记时
        if($('.item-note li').length == 0){
            empty_note();
            return false;
        }

        if($('.detail-container').hasClass('empty')){
            $('.detail-container .empty-img').remove();
            $('.detail-container').removeClass('empty');
        }

        $('.detail-container').addClass('loading').children().hide();

        //有笔记时
        if($('.item-note .li-note.curr').length > 0){
            var rec_id = $('.item-note .li-note.curr').data('id')
        }else if($.cookie('currNote') && $('.item-note .li-note[data-id='+$.cookie('currNote')+']').parents('.item-list').length>0
                && $('.dir-list .li-dir.curr').data('id') == $('.item-list').attr('parent-id')){
            var rec_id = $.cookie('currNote');
        }else{
            var rec_id = $('.item-note li:first-child .li-note').data('id');
        }

        $('.item-note .li-note[data-id='+rec_id+']').addClass('curr');
        ajax_show_note(rec_id);
    }

    //点击搜索图标
    $("body").on("click", '.search-icon', function(){
        search_note();
    })
    //回车搜索
    $("body").on("keydown", '.search-input', function(e){
        if(e.which == 13) search_note();
    });

    //回到上一级
    $("body").on("click", '.item-back', function(){
        if($(this).hasClass('disabled')) return false;
        var type = $('.item-list').attr('type');
        if(type == 'group'){
            var dir_id = $('.item-list').attr('parent-id');
            if($('.dir-warp .curr').hasClass('li-group')){
                //我的协作这两层目录
                var obj = $('.group-list .li-group[group-id='+dir_id+']').parent().parent().prev('div');
            }else{
                var obj = $('.group-list .li-dir[data-id='+dir_id+']').parent().parent().prev('div');
            }
            $('.group-list .curr').removeClass('curr');
            obj.addClass('curr').parents('ul').show().prev('div').children('.down-btn').addClass('pack-up');
            if(obj.data('id') == 0){
                //我的协作列表
                item_list_group();
                return false;
            }
        }else{
            var dir_id = $('.item-list').attr('parent-id');
            if(dir_id == 0) return false;
            $('.dir-list .li-dir.curr').removeClass('curr');
            var obj = $('.dir-list .li-dir[data-id='+dir_id+']').parent().parent().prev('div');
        }
        if(obj.data('id') == 0) $('.item-back').addClass('disabled');
        obj.addClass('curr').parents('ul').show().prev('div').children('.down-btn').addClass('pack-up');
        item_list_dir();
    })

    //item设置
    $("body").on("click", '.setting-icon', function(){
        hide_dropdown_menu('setting');
        if($('.item-setting').hasClass('disabled')) return false;
        if($('.setting-menu').is(":hidden")){
            $('.setting-menu').show();
        }else{
            $('.setting-menu').hide();
        }
        return false;
    })

    $("body").on("click", '.setting-sel', function(){
        $('.setting-sel').removeClass('selected');
        $('.item-note .no-item').remove();
        $(this).addClass('selected');
        $.cookie('setting_value',$(this).data('value'));
        if($('.li-group.curr').length > 0){
            item_list_group();
        }else{
            item_list_dir();
            show_note();
        }
    })

    $("body").on("click", '.setting-sort', function(){
        if($(this).hasClass('desc')){
            var order_by = 'asc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }else if($(this).hasClass('asc')){
            var order_by = 'desc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }else{
            var order_by = 'desc';
            $('.setting-sort').removeClass('selected desc asc');
            $(this).addClass(order_by+' selected');
        }
        $.cookie('setting_col',$(this).data('col'));
        $.cookie('setting_sort',order_by);
        if($('.li-group.curr').length > 0){
            item_list_group();
        }else{
            item_list_dir();
            show_note();
        }
    })

    function alert_msg(status,msg){
        if($('.hint-container').length > 0){
            $('.hint-container').remove();
        }
        var html = '<div class="hint-container"><div class="widget-hint"><p class="'+status+'"><span class="icon-hint"></span><span class="hint-msg">'+msg+'</span></p></div></div>';

        $('.detail-container').append(html);
        var obj = $('.hint-container');
        obj.fadeIn(500);
        setTimeout(function(){
            obj.fadeOut(500,function(){
                if(obj != undefined) obj.remove();
            });
        },2000);
    }


</script>
</html>